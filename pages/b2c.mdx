# B2C Operations

B2C (Business to Customer) operations allow you to send money from your business account to your customers' M-Pesa accounts. This is useful for scenarios like refunds, salary payments, or any other business-to-customer transfers.

## Basic Usage

```php
use MesaSDK\PhpMpesa\Mpesa;
use MesaSDK\PhpMpesa\Config;

$config = new Config();
$config->setBaseUrl("https://apisandbox.safaricom.et")
    ->setConsumerKey("your_consumer_key")
    ->setConsumerSecret("your_consumer_secret")
    ->setEnvironment('sandbox')
    ->setShortCode("your_shortcode")
    ->setInitiatorName("your_initiator_name")
    ->setInitiatorPassword("your_initiator_password");

$mpesa = new Mpesa($config);

// Initiate B2C payment
$result = $mpesa->b2c()
    ->setPhoneNumber("254712345678")
    ->setAmount(100.00)
    ->setCallbackUrl("https://your-domain.com/callback")
    ->setQueueTimeOutUrl("https://your-domain.com/timeout")
    ->setResultUrl("https://your-domain.com/result")
    ->setRemarks("Salary Payment")
    ->setOccasion("Monthly Salary")
    ->send();

if ($result->isSuccessful()) {
    echo "Transaction ID: " . $result->getTransactionID();
} else {
    echo "Error: " . $result->getErrorMessage();
}
```

## Configuration

Before using B2C operations, ensure you have configured:

1. **Shortcode**: Your M-Pesa shortcode
2. **Initiator Name**: Your M-Pesa initiator name
3. **Initiator Password**: Your M-Pesa initiator password
4. **Callback URLs**: URLs to receive transaction notifications
5. **Environment**: Sandbox or Production

## Methods

### setPhoneNumber(string $phone)

Sets the recipient's phone number.

```php
$mpesa->b2c()->setPhoneNumber("254712345678");
```

### setAmount(float $amount)

Sets the transaction amount.

```php
$mpesa->b2c()->setAmount(1000.00);
```

### setCallbackUrl(string $url)

Sets the callback URL for transaction notifications.

```php
$mpesa->b2c()->setCallbackUrl("https://your-domain.com/callback");
```

### setQueueTimeOutUrl(string $url)

Sets the queue timeout URL.

```php
$mpesa->b2c()->setQueueTimeOutUrl("https://your-domain.com/timeout");
```

### setResultUrl(string $url)

Sets the result URL.

```php
$mpesa->b2c()->setResultUrl("https://your-domain.com/result");
```

### setRemarks(string $remarks)

Sets transaction remarks.

```php
$mpesa->b2c()->setRemarks("Salary Payment");
```

### setOccasion(string $occasion)

Sets the transaction occasion.

```php
$mpesa->b2c()->setOccasion("Monthly Salary");
```

### send()

Initiates the B2C payment request.

```php
$result = $mpesa->b2c()->send();
```

## Response Handling

The B2C response includes:

- `TransactionID`: Unique identifier for the transaction
- `ConversationID`: Unique identifier for the conversation
- `OriginatorConversationID`: Original conversation ID
- `ResponseCode`: Response code from M-Pesa
- `ResponseDescription`: Description of the response

```php
if ($result->isSuccessful()) {
    echo "Transaction ID: " . $result->getTransactionID();
    echo "Conversation ID: " . $result->getConversationID();
} else {
    echo "Error: " . $result->getErrorMessage();
}
```

## Checking Transaction Status

After initiating a B2C payment, you can check the transaction status:

```php
$status = $mpesa->checkTransactionStatus($result->getTransactionID());
if ($status->isSuccessful()) {
    echo "Transaction Status: " . $status->getTransactionStatus();
}
```

## Best Practices

1. **Error Handling**

   - Implement comprehensive error handling
   - Log all transactions
   - Monitor failed transactions

2. **Callback Processing**

   - Process callbacks asynchronously
   - Implement retry mechanisms
   - Validate callback data

3. **Security**

   - Use HTTPS for all URLs
   - Validate phone numbers
   - Implement proper authentication
   - Secure initiator credentials

4. **Testing**
   - Test in sandbox environment first
   - Use test phone numbers
   - Verify callback handling
   - Test with various amounts

## Related Topics

- [Callbacks](/callbacks)
- [Error Handling](/error-handling)
- [Transaction Status](/transaction-status)
- [Account Balance](/account-balance)
